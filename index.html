<!DOCTYPE html>
<html lang="do">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deudores - Iniciar Sesión</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- NUEVO: CDNs para Tailwind y Chart.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Archivo de estilos CSS -->
    <link rel="stylesheet" href="estiloh.css">
</head>
<body>

    <!-- Contenedor Principal -->
    <main id="main-container">
        <div class="login-container">
            <div class="login-box">
                <h1 class="title">Deudores</h1>
                <form id="login-form">
                    <div class="input-group">
                        <label for="username">Nombre de Usuario</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="input-group">
                        <label for="role">Tipo de Usuario</label>
                        <select id="role" name="role">
                            <option value="cliente">Cliente</option>
                            <option value="cobrador">Cobrador</option>
                            <option value="administrador">Administrador</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="password">Contraseña</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <p id="error-message" class="error-message"></p>
                    <button type="submit" class="login-button">Entrar</button>
                </form>
            </div>

            <div class="info-container">
                <div class="info-box dollar-rate">
                    <h2>Tasa del Dólar (Venta)</h2>
                    <p id="dollar-rate-value" class="rate">Cargando...</p>
                    <small>Fuente: API Pública</small>
                </div>
                <div class="info-box weather">
                    <h2>Clima en Santo Domingo</h2>
                    <p id="weather-temp" class="temperature">Cargando...</p>
                    <p id="weather-condition" class="condition">Cargando...</p>
                    <small>Fuente: API Pública</small>
                </div>
            </div>
        </div>
    </main>

    <!-- Dashboard del Cliente -->
    <section id="client-dashboard" class="dashboard hidden">
        <div class="dashboard-header">
            <h1 id="client-welcome"></h1>
            <button class="logout-button">Cerrar Sesión</button>
        </div>
        <div class="dashboard-content-grid">
             <div class="main-content-area">
                <div class="card">
                    <h3>Estado de Cuenta</h3>
                    <div id="late-fee-warning" class="late-warning hidden">
                        <p><strong>¡Atención!</strong> Su pago está atrasado.</p>
                    </div>
                    <p><strong>Monto Total Adeudado:</strong> RD$ <span id="total-debt"></span></p>
                    <p><strong>Total de Pagos (Aprobados):</strong> RD$ <span id="payments-made"></span></p>
                    <p class="balance"><strong>Balance Pendiente:</strong> RD$ <span id="current-balance"></span></p>
                </div>
                <div class="card">
                    <h3>Historial de Transacciones (Pagos Aprobados)</h3>
                    <div id="payment-history-container"></div>
                </div>
            </div>
            <div class="sidebar-area">
                <div class="card">
                    <h3>Información del Perfil</h3>
                    <p><strong>Dirección:</strong> <span id="client-address"></span></p>
                    <p><strong>Contacto:</strong> <span id="client-contact"></span></p>
                    <p><strong>Cédula:</strong> <span id="client-id"></span></p>
                </div>
                 <div id="client-plan-card" class="card hidden">
                    <h3>Mi Plan de Pago</h3>
                    <p><strong>Frecuencia:</strong> <span id="plan-frequency"></span></p>
                    <p><strong>Monto por Cuota:</strong> RD$ <span id="plan-amount"></span></p>
                    <p><strong>Próximo Vencimiento:</strong> <span id="plan-due-date"></span></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard del Administrador -->
    <section id="admin-dashboard" class="dashboard hidden">
        <div class="dashboard-header">
            <h1>Panel de Administración</h1>
            <button class="logout-button">Cerrar Sesión</button>
        </div>
        <div class="dashboard-content">
            
            <!-- INICIO: Dashboard Financiero Integrado -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Dashboard Financiero</h2>
            <section id="kpi-section" class="mb-6">
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="kpi-card">
                        <h3 class="kpi-title">Deuda Total Pendiente</h3>
                        <p id="kpi-total-debt" class="kpi-value text-red-700">RD$ 0.00</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-title">Total Recaudado (Aprobado)</h3>
                        <p id="kpi-total-collected" class="kpi-value text-green-700">RD$ 0.00</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-title">Pagos Pendientes</h3>
                        <p id="kpi-pending-payments" class="kpi-value text-yellow-600">RD$ 0.00</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="kpi-title">Clientes Atrasados</h3>
                        <p id="kpi-overdue-clients" class="kpi-value text-orange-600">0</p>
                    </div>
                </div>
            </section>

            <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                    <h3 class="font-bold text-lg mb-2">Evolución de Deuda vs. Pagos</h3>
                    <div class="chart-container">
                        <canvas id="debtVsPaymentsChart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-1 bg-white p-4 rounded-lg shadow">
                     <h3 class="font-bold text-lg mb-2">Estado de Transacciones</h3>
                    <div class="chart-container">
                        <canvas id="transactionStatusChart"></canvas>
                    </div>
                </div>
            </section>
            <!-- FIN: Dashboard Financiero Integrado -->

            <div id="pending-payments-section" class="card hidden">
                <h3>Pagos Pendientes de Aprobación</h3>
                <div id="pending-payments-list"></div>
            </div>
            <div class="card">
                <h3>Gestión de Clientes</h3>
                <div class="admin-actions">
                    <div class="search-container"><input type="text" id="client-search-input" placeholder="Buscar cliente por nombre..."></div>
                    <button id="create-client-button" class="button-new-client">Crear Nuevo Cliente</button>
                </div>
                <div id="client-list-container"></div>
            </div>
        </div>
    </section>

    <!-- Dashboard del Cobrador -->
    <section id="collector-dashboard" class="dashboard hidden">
        <div class="dashboard-header">
            <h1 id="collector-welcome"></h1>
            <button class="logout-button">Cerrar Sesión</button>
        </div>
        <div class="dashboard-content">
            <div class="card">
                <h3>Registrar Pagos de Clientes</h3>
                <div class="admin-actions">
                    <div class="search-container">
                        <input type="text" id="collector-client-search" placeholder="Buscar cliente por nombre...">
                    </div>
                </div>
                <div id="collector-client-list"></div>
            </div>
        </div>
    </section>

    <!-- Modales (sin cambios) -->
    <div id="manage-client-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-client-name"></h2><button class="close-modal-button">&times;</button></div>
            <div class="modal-body">
                <form id="manage-client-form">
                    <div class="input-group">
                        <label for="new-payment">Registrar Nuevo Pago (Aprobado Directo)</label>
                        <input type="number" id="new-payment" placeholder="0.00" min="0">
                    </div>
                    <hr>
                    <div class="input-group"><label for="update-debt">Actualizar Deuda Total (RD$)</label><input type="number" id="update-debt" placeholder="0.00" min="0"></div>
                    <p class="modal-info">Deja un campo en blanco si no deseas modificarlo.</p>
                    <button type="submit" class="button-primary">Guardar Cambios</button>
                </form>
                <div id="late-fee-section" class="late-fee-section hidden"><hr><p>El cliente está atrasado. Puede aplicar el cargo por mora.</p><button id="apply-late-fee-button" class="button-danger">Aplicar Cargo por Mora</button></div>
            </div>
        </div>
    </div>
    <div id="register-payment-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-collector-client-name"></h2><button class="close-modal-button">&times;</button></div>
            <div class="modal-body">
                <form id="register-payment-form">
                    <div class="input-group">
                        <label for="collector-new-payment">Monto del Pago (RD$)</label>
                        <input type="number" id="collector-new-payment" placeholder="0.00" min="1" required>
                    </div>
                    <p class="modal-info">Este pago requerirá aprobación del administrador.</p>
                    <button type="submit" class="button-primary">Registrar Pago</button>
                </form>
            </div>
        </div>
    </div>
    <div id="create-client-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h2>Crear Nuevo Cliente</h2><button class="close-modal-button">&times;</button></div>
            <div class="modal-body">
                <form id="create-client-form">
                    <div id="personal-data-step">
                        <h4>Paso 1: Datos Personales y Credenciales</h4>
                        <div class="input-group"><label for="new-fullname">Nombre Completo</label><input type="text" id="new-fullname" required></div>
                        <div class="input-group"><label for="new-username">Nombre de Usuario</label><input type="text" id="new-username" required></div>
                        <div class="input-group"><label for="new-password">Contraseña</label><input type="password" id="new-password" required></div>
                        <div class="input-group"><label for="new-address">Dirección</label><input type="text" id="new-address"></div>
                        <div class="input-group"><label for="new-contact">Contacto</label><input type="text" id="new-contact"></div>
                        <div class="input-group"><label for="new-idnumber">Cédula</label><input type="text" id="new-idnumber"></div>
                        <p id="create-error-message-step1" class="error-message"></p>
                        <button type="button" id="next-step-button" class="button-primary">Siguiente</button>
                    </div>
                    <div id="loan-conditions-step" class="hidden">
                        <h4>Paso 2: Condiciones del Préstamo</h4>
                        <div class="input-group"><label for="initial-debt">Deuda Inicial (RD$)</label><input type="number" id="initial-debt" min="1" required></div>
                        <div class="input-group"><label for="loan-term">Plazo del Préstamo (meses)</label><input type="number" id="loan-term" min="1" required></div>
                        <div class="input-group"><label for="interest-rate">Tasa de Interés Mensual (%)</label><input type="number" id="interest-rate" min="0" step="0.1" required></div>
                        <div class="input-group"><label for="late-fee-rate">Tasa de Mora Mensual (%)</label><input type="number" id="late-fee-rate" min="0" step="0.1" required></div>
                        <div class="form-navigation"><button type="button" id="prev-step-button" class="button-secondary">Atrás</button><button type="submit" class="button-primary">Generar Planes de Pago</button></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="payment-plan-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h2>Seleccionar Plan de Pago</h2><button class="close-modal-button">&times;</button></div>
            <div class="modal-body">
                <p>Elija el plan de pago para el nuevo cliente.</p>
                <form id="select-plan-form">
                    <div id="plan-options-container"></div>
                    <p id="plan-error-message" class="error-message"></p>
                    <button type="submit" class="button-primary">Confirmar Plan y Crear Cliente</button>
                </form>
            </div>
        </div>
    </div>
    <div id="notification-toast" class="toast hidden"></div>
    
    <script src="scripth.js"></script>
</body>
</html>